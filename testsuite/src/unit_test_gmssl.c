/*
 *  CUnit - A Unit testing framework library for C.
 *  Copyright (C) 2001        Anil Kumar
 *  Copyright (C) 2004, 2005  Anil Kumar, Jerry St.Clair
 *
 *  This library is free software; you can redistribute it and/or
 *  modify it under the terms of the GNU Library General Public
 *  License as published by the Free Software Foundation; either
 *  version 2 of the License, or (at your option) any later version.
 *
 *  This library is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 *  Library General Public License for more details.
 *
 *  You should have received a copy of the GNU Library General Public
 *  License along with this library; if not, write to the Free Software
 *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>


#include "CUnit.h"
#include "unit_test_gmssl.h"
#include "openssl/sms4.h"
/* WARNING - MAINTENANCE NIGHTMARE AHEAD
 *
 * If you change any of the tests & suites below, you also need
 * to keep track of changes in the result statistics and reflect
 * any changes in the result report counts in print_example_results().
 *
 * Yes, this could have been designed better using a more
 * automated mechanism.  No, it was not done that way.
 */

/* Suite initialization/cleanup functions */
static int suite_success_init(void) {
    printf("suite_succuse_init\n");
    return 0; }
static int suite_success_clean(void) { return 0; }

static int suite_failure_init(void) { return 1;}
static int suite_failure_clean(void) { return 1; }

static void testSuccess1(void) { CU_ASSERT(1); }
static void testSuccess2(void) { CU_ASSERT(2); }
static void testSuccess3(void) { CU_ASSERT(3); }

static void testSuiteFailure1(void) { CU_ASSERT(0); }
static void testSuiteFailure2(void) { CU_ASSERT(2); }

static void testFailure1(void) { CU_ASSERT(0); }
static void testFailure2(void) { CU_ASSERT(0); }
static void testFailure3(void) { CU_ASSERT(0); }

#define TEST_FUN(a)  ((void*)a)


static const unsigned char sm4_test_ecb_enc[16] =
        {
                0xC3, 0x4C, 0x05, 0x2C, 0xC0, 0xDA, 0x8D, 0x73,
                0x45, 0x1A, 0xFE, 0x5F, 0x03, 0xBE, 0x29, 0x7F
        };

static const unsigned char sm4_test_ecb_key[16] =
        {
                0x2B, 0x7E, 0x15, 0x16, 0x28, 0xAE, 0xD2, 0xA6,
                0xAB, 0xF7, 0x15, 0x88, 0x09, 0xCF, 0x4F, 0x3C
        };
static const unsigned char sm4_test_ecb_dec[16] = {
        0xe5,0x3e,0x07,0xc9,0x94,0xf8,0xc9,0xda,0x3f,0x55,0x2b,0xae,0xdc,0x6c,0x1e,0xf8
};
static void test_gmssl_sm4_ecb_enc(void)
{
    sms4_key_t key;
    unsigned char dec_plain[16] = {0};
    unsigned char i = 0;
    int ret;
    sms4_set_encrypt_key(&key, sm4_test_ecb_key);
    sms4_ecb_encrypt(sm4_test_ecb_enc, dec_plain, &key, 1);

#if 0
    for (i = 0; i < 16; i ++) {
        printf("0x%2x,", dec_plain[i]);
    }
    printf("            ");
#endif
    ret = memcmp(sm4_test_ecb_dec, dec_plain, sizeof sm4_test_ecb_enc);
    CU_ASSERT_NSTRING_EQUAL(sm4_test_ecb_dec, dec_plain, sizeof dec_plain)
}

static void test_gmssl_sm4_ecb_dec(void)
{
    sms4_key_t key;
    unsigned char enc_plain[16] = {0};
    unsigned char i = 0;
    int ret;
    sms4_set_decrypt_key(&key, sm4_test_ecb_key);
    sms4_ecb_encrypt(sm4_test_ecb_dec, enc_plain, &key, 0);
#if 0
    for (i = 0; i < 16; i ++) {
        printf("0x%2x,", enc_plain[i]);
    }
    printf("            ");
#endif
    ret = memcmp(enc_plain, sm4_test_ecb_dec, sizeof sm4_test_ecb_dec);
    CU_ASSERT_NSTRING_EQUAL(sm4_test_ecb_enc, enc_plain, sizeof 0)
}

static const unsigned char sm4_test_cbc_enc[256] = {
        0x13,0x9e,0x26,0xaf,0xc5,0x72,0x44,0xbc,0x6d,0x78,0x50,0x66,0x2f,0x66,0x8f,0x8e,
        0x4f,0xa0,0x34,0x03,0x7c,0x72,0x20,0x46,0x12,0xbd,0x7b,0x74,0xbe,0xf7,0x38,0x11,
        0x9d,0xe6,0x03,0x8b,0x4f,0xcc,0x42,0x16,0xa7,0xd0,0x8d,0x9b,0x7d,0x9e,0x10,0x36,
        0x9d,0x38,0x35,0x76,0x31,0xa3,0x23,0x54,0x74,0x1e,0xc1,0x16,0xd3,0x18,0x59,0xfb,
        0xdf,0x2a,0x7b,0xe4,0x2b,0x0d,0xd3,0xa0,0xb2,0x0f,0x9a,0xe9,0x7e,0xc8,0x0e,0x1e,
        0x13,0xea,0x6a,0x20,0xb9,0x0f,0x68,0x06,0xe4,0xb7,0xad,0x7d,0xca,0xb1,0x83,0x10,
        0xa2,0x9e,0x9f,0xd8,0x39,0x47,0x8f,0x7a,0x8f,0x70,0x57,0xbd,0x90,0xef,0xec,0x5f,
        0xb4,0x1e,0x62,0xe8,0xd6,0x35,0xc5,0x87,0x52,0x27,0x94,0xcd,0xe4,0x53,0xeb,0xb5,
        0xa2,0xd9,0x28,0x61,0x34,0x43,0xab,0x5a,0xd9,0xc9,0x38,0x50,0xba,0x35,0x0c,0x4c,
        0x8c,0xd7,0xc7,0xaa,0x79,0x2f,0x0d,0x00,0x27,0x90,0x08,0x04,0x50,0xbe,0xd8,0x7b,
        0x92,0x08,0x9b,0xb7,0x6d,0xe1,0xc2,0x2e,0x13,0xce,0xbd,0xa3,0xd5,0x22,0x46,0xb9,
        0x27,0xee,0x57,0x28,0xe8,0x7a,0x27,0x2f,0x3c,0x2e,0xbe,0xd0,0xfa,0xd1,0xad,0x91,
        0xb4,0xb4,0x2c,0x43,0xce,0x45,0xc0,0xdb,0x73,0x44,0x65,0x57,0xb4,0x4c,0xda,0x4a,
        0xbb,0xc6,0x25,0x8c,0x5f,0x7a,0x24,0xd5,0xac,0xc4,0xc3,0x0a,0xcb,0x7d,0x7e,0x48,
        0x04,0x40,0xba,0x33,0x79,0xca,0x50,0x1d,0x4f,0xf5,0xbd,0x8e,0x4b,0xee,0xef,0xe6,
        0xcd,0x00,0xe7,0x3f,0xd9,0x65,0xd0,0xcc,0x60,0x27,0x80,0x7b,0xe3,0x7e,0x07,0x85
};

static const unsigned char sm4_test_cbc_key[16] =
        {
                0x2B, 0x7E, 0x15, 0x16, 0x28, 0xAE, 0xD2, 0xA6,
                0xAB, 0xF7, 0x15, 0x88, 0x09, 0xCF, 0x4F, 0x3C,
        };
static const unsigned char sm4_test_cbc_iv[16] = {
        0x55, 0x5c, 0x82, 0x24, 0xe2, 0xc9, 0x58, 0x73,
        0x12, 0x08, 0x5b, 0xfb, 0x4e, 0xcb, 0x04, 0xb8,
};

static const unsigned char sm4_test_cbc_dec[256] = {
        0x41,0x7d,0x91,0xeb,0x39,0x8f,0x07,0x45,0x6c,0xa4,0xff,0xe2,0xa1,0x1b,0xa0,0xe3,
        0xe4,0x75,0x82,0x14,0xa5,0x01,0xb2,0x38,0xd5,0x84,0xf0,0xd0,0xa6,0x2d,0x76,0xb3,
        0x30,0x30,0x95,0x6d,0x91,0x4c,0xc1,0xb7,0x20,0xd7,0x06,0xed,0x2c,0x40,0xaa,0xb3,
        0xa0,0x03,0x6b,0xb5,0x17,0xb8,0x80,0x55,0x4e,0x73,0x6f,0x08,0x14,0x98,0xc3,0x0b,
        0xb8,0x99,0xd2,0xa6,0xce,0xe7,0xac,0x20,0x75,0xef,0xa6,0x11,0x46,0xd5,0x8e,0x75,
        0x4d,0xa0,0x59,0x2f,0xcb,0x87,0xfb,0xe1,0xba,0x06,0xcd,0xe2,0x7a,0x5f,0x97,0x51,
        0x7e,0x70,0x2f,0xea,0xa7,0x46,0x0b,0x70,0x3b,0xd7,0x30,0xcd,0x91,0xd9,0x75,0x52,
        0x5e,0x79,0xa6,0xc4,0xbd,0x58,0x88,0xfe,0x96,0xb8,0xf7,0xb4,0x1e,0x3f,0xed,0x87,
        0x91,0xb4,0x39,0x59,0xf6,0xe5,0x41,0x48,0xfe,0x73,0xbf,0x89,0x64,0x14,0xc2,0xce,
        0xbf,0xb4,0xf7,0x75,0xae,0x5b,0xbc,0xed,0x45,0x3d,0xba,0x6e,0x22,0xb3,0x67,0x11,
        0x34,0xf7,0xfa,0x09,0xd0,0xa2,0x68,0x08,0xa4,0xad,0xe6,0xf5,0x12,0x1c,0xdc,0x0c,
        0x4a,0x5b,0xe8,0x99,0xb3,0xa6,0xbf,0xa0,0xb4,0x6d,0x2e,0x6e,0xa0,0x0a,0x08,0x5f,
        0xe5,0x79,0xf9,0x38,0xfc,0x14,0x22,0x5f,0xcd,0x4e,0x69,0xf0,0xa8,0x70,0x59,0x0d,
        0xc6,0x4a,0x7a,0xe4,0xdb,0x15,0x1a,0xdb,0xa6,0xa8,0x1b,0xe8,0x43,0xb7,0xd8,0xbe,
        0x55,0x4d,0x08,0xed,0xb6,0x37,0x7b,0x7b,0x8a,0x51,0x6d,0x75,0x2c,0xbe,0x74,0x52,
        0xce,0x6a,0x81,0xd5,0x09,0x08,0xd6,0x8e,0x8e,0x97,0x98,0x1b,0x25,0x4e,0x0b,0x70,
};

static void test_gmssl_sm4_cbc_enc(void)
{
    unsigned char dec_plain[256] = {0};
    unsigned int i = 0;
    uint8_t iv[16] = {0};
    sms4_key_t key;
    int ret;

    sms4_set_encrypt_key(&key, sm4_test_cbc_key);
    memcpy(iv, sm4_test_cbc_iv, sizeof iv);
    sms4_cbc_encrypt(sm4_test_cbc_enc, dec_plain, sizeof(dec_plain), &key, iv, 1);

#if 0
    for (i = 0; i < sizeof(dec_plain); i ++) {
        if (i % 16 == 0) {
            printf("\n");
        }
        printf("0x%2x,", dec_plain[i]);
    }
    printf("            ");
#endif
    ret = memcmp(sm4_test_cbc_enc, dec_plain, sizeof sm4_test_ecb_enc);
    CU_ASSERT_NSTRING_EQUAL(sm4_test_cbc_dec, dec_plain, sizeof dec_plain)
}

static void test_gmssl_sm4_cbc_dec(void)
{
    unsigned char enc_plain[256] = {0};
    unsigned int i = 0;
    uint8_t iv[16] = {0};
    sms4_key_t key;
    int ret;

    sms4_set_decrypt_key(&key, sm4_test_cbc_key);
    memcpy(iv, sm4_test_cbc_iv, sizeof iv);
    sms4_cbc_encrypt(sm4_test_cbc_dec, enc_plain, sizeof(enc_plain), &key, iv, 0);
#if 0
    for (i = 0; i < sizeof(enc_plain); i ++) {
        if (i % 16 == 0) {
            printf("\n");
        }
        printf("0x%2x,", enc_plain[i]);
    }
    printf("            ");
#endif
    ret = memcmp(sm4_test_cbc_enc, enc_plain, sizeof sm4_test_ecb_enc);
    CU_ASSERT_NSTRING_EQUAL(sm4_test_cbc_enc, enc_plain, sizeof enc_plain)
}


static const unsigned char sm4_test_ctr_enc[512] = {
        0x13,0x9e,0x26,0xaf,0xc5,0x72,0x44,0xbc,0x6d,0x78,0x50,0x66,0x2f,0x66,0x8f,0x8e,
        0x4f,0xa0,0x34,0x03,0x7c,0x72,0x20,0x46,0x12,0xbd,0x7b,0x74,0xbe,0xf7,0x38,0x11,
        0x9d,0xe6,0x03,0x8b,0x4f,0xcc,0x42,0x16,0xa7,0xd0,0x8d,0x9b,0x7d,0x9e,0x10,0x36,
        0x9d,0x38,0x35,0x76,0x31,0xa3,0x23,0x54,0x74,0x1e,0xc1,0x16,0xd3,0x18,0x59,0xfb,
        0xdf,0x2a,0x7b,0xe4,0x2b,0x0d,0xd3,0xa0,0xb2,0x0f,0x9a,0xe9,0x7e,0xc8,0x0e,0x1e,
        0x13,0xea,0x6a,0x20,0xb9,0x0f,0x68,0x06,0xe4,0xb7,0xad,0x7d,0xca,0xb1,0x83,0x10,
        0xa2,0x9e,0x9f,0xd8,0x39,0x47,0x8f,0x7a,0x8f,0x70,0x57,0xbd,0x90,0xef,0xec,0x5f,
        0xb4,0x1e,0x62,0xe8,0xd6,0x35,0xc5,0x87,0x52,0x27,0x94,0xcd,0xe4,0x53,0xeb,0xb5,
        0xa2,0xd9,0x28,0x61,0x34,0x43,0xab,0x5a,0xd9,0xc9,0x38,0x50,0xba,0x35,0x0c,0x4c,
        0x8c,0xd7,0xc7,0xaa,0x79,0x2f,0x0d,0x00,0x27,0x90,0x08,0x04,0x50,0xbe,0xd8,0x7b,
        0x92,0x08,0x9b,0xb7,0x6d,0xe1,0xc2,0x2e,0x13,0xce,0xbd,0xa3,0xd5,0x22,0x46,0xb9,
        0x27,0xee,0x57,0x28,0xe8,0x7a,0x27,0x2f,0x3c,0x2e,0xbe,0xd0,0xfa,0xd1,0xad,0x91,
        0xb4,0xb4,0x2c,0x43,0xce,0x45,0xc0,0xdb,0x73,0x44,0x65,0x57,0xb4,0x4c,0xda,0x4a,
        0xbb,0xc6,0x25,0x8c,0x5f,0x7a,0x24,0xd5,0xac,0xc4,0xc3,0x0a,0xcb,0x7d,0x7e,0x48,
        0x04,0x40,0xba,0x33,0x79,0xca,0x50,0x1d,0x4f,0xf5,0xbd,0x8e,0x4b,0xee,0xef,0xe6,
        0xcd,0x00,0xe7,0x3f,0xd9,0x65,0xd0,0xcc,0x60,0x27,0x80,0x7b,0xe3,0x7e,0x07,0x85,
        0x13,0x9e,0x26,0xaf,0xc5,0x72,0x44,0xbc,0x6d,0x78,0x50,0x66,0x2f,0x66,0x8f,0x8e,
        0x4f,0xa0,0x34,0x30,0x7c,0x72,0x20,0x46,0x12,0xbd,0x7b,0x74,0xbe,0xf7,0x38,0x11,
        0x9d,0xe6,0x30,0x8b,0x4f,0xcc,0x42,0x16,0xa7,0xd0,0x8d,0x9b,0x7d,0x9e,0x10,0x36,
        0x9d,0x38,0x35,0x76,0x31,0xa3,0x23,0x54,0x74,0x1e,0xc1,0x16,0xd3,0x18,0x59,0xfb,
        0xdf,0x2a,0x7b,0xe4,0x2b,0x0d,0xd3,0xa0,0xb2,0x0f,0x9a,0xe9,0x7e,0xc8,0x0e,0x1e,
        0x13,0xea,0x6a,0x20,0xb9,0x0f,0x68,0x06,0xe4,0xb7,0xad,0x7d,0xca,0xb1,0x83,0x10,
        0xa2,0x9e,0x9f,0xd8,0x39,0x47,0x8f,0x7a,0x8f,0x70,0x57,0xbd,0x90,0xef,0xec,0x5f,
        0xb4,0x1e,0x62,0xe8,0xd6,0x35,0xc5,0x87,0x52,0x27,0x94,0xcd,0xe4,0x53,0xeb,0xb5,
        0xa2,0xd9,0x28,0x61,0x34,0x43,0xab,0x5a,0xd9,0xc9,0x38,0x50,0xba,0x35,0x0c,0x4c,
        0x8c,0xd7,0xc7,0xaa,0x79,0x2f,0x0d,0x00,0x27,0x90,0x08,0x04,0x50,0xbe,0xd8,0x7b,
        0x92,0x08,0x9b,0xb7,0x6d,0xe1,0xc2,0x2e,0x13,0xce,0xbd,0xa3,0xd5,0x22,0x46,0xb9,
        0x27,0xee,0x57,0x28,0xe8,0x7a,0x27,0x2f,0x3c,0x2e,0xbe,0xd0,0xfa,0xd1,0xad,0x91,
        0xb4,0xb4,0x2c,0x43,0xce,0x45,0xc0,0xdb,0x73,0x44,0x65,0x57,0xb4,0x4c,0xda,0x4a,
        0xbb,0xc6,0x25,0x8c,0x5f,0x7a,0x24,0xd5,0xac,0xc4,0xc3,0x0a,0xcb,0x7d,0x7e,0x48,
        0x40,0x40,0xba,0x33,0x79,0xca,0x50,0x1d,0x4f,0xf5,0xbd,0x8e,0x4b,0xee,0xef,0xe6,
        0xcd,0x00,0xe7,0x3f,0xd9,0x65,0xd0,0xcc,0x60,0x27,0x80,0x7b,0xe3,0x7e,0x46,0x89
};

static const unsigned char sm4_test_ctr_key[16] = {
        0x2B, 0x7E, 0x15, 0x16, 0x28, 0xAE, 0xD2, 0xA6,
        0xAB, 0xF7, 0x15, 0x88, 0x09, 0xCF, 0x4F, 0x3C,
};
static const unsigned char sm4_test_ctr_iv[16] = {
        0x55, 0x5c, 0x82, 0x24, 0xe2, 0xc9, 0x58, 0x73,
        0x12, 0x08, 0x5b, 0xfb, 0x4e, 0xcb, 0x04, 0xb8,
};

static const unsigned char sm4_test_ctr_dec[512] = {
        0xf5,0x06,0x62,0xde,0xbf,0x0d,0xe2,0x0f,0xfe,0xb5,0x9d,0x31,0xeb,0x5e,0xb4,0xd3,
        0x6a,0x31,0x13,0x07,0x35,0x41,0x50,0x48,0x60,0xd7,0x50,0xbd,0xea,0x9b,0xdd,0x79,
        0xd0,0x04,0x0e,0xd7,0xc9,0x29,0x58,0xab,0x86,0x11,0xa1,0x19,0x73,0x84,0x61,0x84,
        0x50,0x6b,0x78,0x01,0xfb,0x32,0x14,0x65,0x1d,0x64,0xf8,0x25,0xd1,0xa1,0x11,0xea,
        0xbe,0x60,0x69,0x16,0x85,0x0b,0xa7,0xe8,0x52,0x4a,0x38,0x95,0x8c,0x17,0x3e,0x4f,
        0xb6,0x11,0x52,0x9d,0x81,0x65,0xe5,0xad,0xcb,0x8a,0x13,0x6b,0xfc,0x3a,0xbf,0xe7,
        0xe7,0x17,0xf4,0x14,0x34,0xaf,0x7e,0x12,0xd1,0x45,0x7d,0xa6,0x25,0x23,0xa6,0xeb,
        0x7f,0x18,0xdf,0x47,0xed,0x49,0x54,0xba,0x77,0xec,0xcc,0x19,0xd3,0x36,0xea,0x8c,
        0x63,0x9f,0x07,0xbf,0xab,0x90,0x21,0x71,0x6a,0x31,0xa8,0x72,0x1b,0x9a,0xb9,0x7a,
        0x0c,0x50,0x9d,0x6a,0x53,0x8e,0x80,0x76,0x35,0x3e,0x82,0x67,0xa0,0xc7,0x45,0x69,
        0x80,0x42,0xa1,0xde,0x89,0xb3,0x39,0xe6,0x22,0x5f,0x01,0x39,0x39,0xac,0x40,0xf9,
        0xdc,0x52,0xd1,0x94,0x18,0x8b,0x4b,0x3f,0xb9,0x2e,0x25,0x80,0x03,0x62,0xe3,0x4a,
        0x90,0x51,0xc5,0x1a,0xe1,0x3a,0xce,0xab,0x6e,0x43,0xc4,0xd6,0x0f,0x09,0x96,0x1f,
        0xf2,0x49,0x20,0x98,0xa1,0xa0,0xb7,0x3e,0xa5,0x97,0xa9,0x9c,0x94,0x1d,0xcb,0xde,
        0xec,0xb5,0x29,0x9a,0x62,0xfb,0x13,0x67,0x2d,0x23,0xf9,0xa4,0x2a,0x89,0xc1,0x3d,
        0x31,0x52,0xdd,0x6c,0x96,0xe4,0xe9,0xe2,0x59,0x54,0x54,0xc5,0xf8,0x40,0xdb,0xc6,
        0xef,0xee,0x55,0x52,0x93,0x45,0x78,0x5d,0x4e,0x39,0x15,0xbb,0x16,0xab,0x33,0xac,
        0x6c,0xb9,0x66,0x56,0x06,0x65,0x9f,0x3d,0xe4,0x58,0x90,0x18,0x7e,0x74,0x0a,0xff,
        0xdf,0xf3,0x0e,0x23,0x4d,0xe5,0x85,0x6b,0x5f,0x6a,0xcc,0xf8,0x89,0x2b,0x4b,0xb5,
        0xbe,0xf7,0xaf,0xf2,0x74,0x76,0x0f,0x71,0xa4,0x38,0x07,0xf5,0x6d,0xfa,0x86,0x37,
        0x63,0x55,0xf0,0xb6,0x2c,0xba,0x09,0x68,0x67,0x16,0x9a,0xc0,0x7e,0x39,0x71,0x43,
        0x9b,0xf2,0xd8,0xac,0x7e,0xf0,0x7a,0x0a,0x9e,0x7a,0x84,0x73,0x97,0xd7,0xbc,0x9a,
        0xa0,0xe8,0xa0,0x5a,0xbf,0x38,0x8c,0x64,0x59,0xd2,0xd0,0x64,0x66,0x78,0x43,0x50,
        0x68,0x09,0xdf,0xd7,0x2c,0x1d,0x1d,0xb1,0x3b,0x7d,0x78,0x44,0x1c,0xdb,0x65,0xc8,
        0x38,0x1b,0x57,0xeb,0x51,0x52,0xcb,0xa0,0xd3,0xc7,0x57,0x43,0x78,0x76,0x79,0x0f,
        0x7b,0xdf,0xb8,0x76,0xbd,0x8e,0xbe,0x52,0xd7,0x30,0xd9,0xf4,0x2a,0x0c,0xe7,0xbe,
        0xde,0xbe,0x62,0xa7,0xf1,0x5e,0x83,0xe7,0xbb,0x39,0xf7,0x0a,0x5c,0xa7,0x86,0x3f,
        0x5c,0x4f,0xae,0x83,0x87,0x64,0x00,0x19,0x71,0x26,0xa1,0x03,0x75,0xe5,0xa1,0xe4,
        0x30,0xdc,0xee,0x46,0x7c,0x40,0x52,0x1a,0x9e,0xbd,0x68,0xfb,0x72,0x7e,0xc2,0xae,
        0xbb,0x2c,0x21,0x0b,0xce,0x49,0x90,0x17,0xe8,0xf8,0x9e,0xd4,0xd0,0xe3,0xab,0x70,
        0x55,0x5a,0x25,0xed,0x74,0x05,0x10,0x8f,0x72,0xaa,0x90,0x76,0x35,0x91,0xcf,0x92,
        0x31,0x2e,0xd4,0xb4,0xc7,0x9c,0x76,0xa2,0x6b,0xdc,0x8a,0x20,0xaf,0xc8,0x76,0xb3,
};
void sms4_ctr128_encrypt(const unsigned char *in, unsigned char *out,
                         size_t len, const sms4_key_t *key, unsigned char *iv,
                         unsigned char ecount_buf[SMS4_BLOCK_SIZE], unsigned int *num);
static void test_gmssl_sm4_ctr_enc(void)
{
    unsigned char dec_plain[512] = {0};
    unsigned int i = 0;
    int ret = 0;
    uint8_t iv[16] = {0};
    uint8_t strblk[16] = {0};
    size_t nc_off = 0;
    sms4_key_t key;
    memset(strblk,0,sizeof strblk);
    memcpy(iv, sm4_test_ctr_iv, sizeof iv);

    sms4_set_encrypt_key(&key, sm4_test_cbc_key);
    sms4_ctr128_encrypt(sm4_test_ctr_enc, dec_plain, sizeof(dec_plain), &key, iv, strblk, &nc_off);

#if 0
    for (i = 0; i < sizeof(dec_plain); i ++) {
        if (i % 16 == 0) {
            printf("\n");
        }
        printf("0x%2x,", dec_plain[i]);
    }
    printf("            ");
#endif
    CU_ASSERT_NSTRING_EQUAL(sm4_test_ctr_dec, dec_plain, sizeof dec_plain)
}

static void test_gmssl_sm4_ctr_dec(void)
{
    unsigned char enc_plain[512] = {0};
    unsigned int i = 0;
    int ret = 0;
    uint8_t iv[16] = {0};
    uint8_t strblk[16] = {0};
    size_t nc_off = 0;
    sms4_key_t key;
    memset(strblk,0,sizeof strblk);
    memcpy(iv, sm4_test_ctr_iv, sizeof iv);
    sms4_set_encrypt_key(&key, sm4_test_ctr_key);
    sms4_ctr128_encrypt(sm4_test_ctr_dec, enc_plain, sizeof(enc_plain), &key, iv, strblk, &nc_off);
#if 0
    for (i = 0; i < sizeof(enc_plain); i ++) {
        if (i % 16 == 0) {
            printf("\n");
        }
        printf("0x%2x,", enc_plain[i]);
    }
    printf("            ");
#endif
    ret = memcmp(sm4_test_ctr_dec, enc_plain, sizeof enc_plain);
    CU_ASSERT_NSTRING_EQUAL(sm4_test_ctr_enc, enc_plain, sizeof enc_plain)
}


static const unsigned char sm4_test_ctr_enc_str[512] = {
        0x13,0x9e,0x26,0xaf,0xc5,0x72,0x44,0xbc,0x6d,0x78,0x50,0x66,0x2f,0x66,0x8f,0x8e,
        0x4f,0xa0,0x34,0x03,0x7c,0x72,0x20,0x46,0x12,0xbd,0x7b,0x74,0xbe,0xf7,0x38,0x11,
        0x9d,0xe6,0x03,0x8b,0x4f,0xcc,0x42,0x16,0xa7,0xd0,0x8d,0x9b,0x7d,0x9e,0x10,0x36,
        0x9d,0x38,0x35,0x76,0x31,0xa3,0x23,0x54,0x74,0x1e,0xc1,0x16,0xd3,0x18,0x59,0xfb,
        0xdf,0x2a,0x7b,0xe4,0x2b,0x0d,0xd3,0xa0,0xb2,0x0f,0x9a,0xe9,0x7e,0xc8,0x0e,0x1e,
        0x13,0xea,0x6a,0x20,0xb9,0x0f,0x68,0x06,0xe4,0xb7,0xad,0x7d,0xca,0xb1,0x83,0x10,
        0xa2,0x9e,0x9f,0xd8,0x39,0x47,0x8f,0x7a,0x8f,0x70,0x57,0xbd,0x90,0xef,0xec,0x5f,
        0xb4,0x1e,0x62,0xe8,0xd6,0x35,0xc5,0x87,0x52,0x27,0x94,0xcd,0xe4,0x53,0xeb,0xb5,
        0xa2,0xd9,0x28,0x61,0x34,0x43,0xab,0x5a,0xd9,0xc9,0x38,0x50,0xba,0x35,0x0c,0x4c,
        0x8c,0xd7,0xc7,0xaa,0x79,0x2f,0x0d,0x00,0x27,0x90,0x08,0x04,0x50,0xbe,0xd8,0x7b,
        0x92,0x08,0x9b,0xb7,0x6d,0xe1,0xc2,0x2e,0x13,0xce,0xbd,0xa3,0xd5,0x22,0x46,0xb9,
        0x27,0xee,0x57,0x28,0xe8,0x7a,0x27,0x2f,0x3c,0x2e,0xbe,0xd0,0xfa,0xd1,0xad,0x91,
        0xb4,0xb4,0x2c,0x43,0xce,0x45,0xc0,0xdb,0x73,0x44,0x65,0x57,0xb4,0x4c,0xda,0x4a,
        0xbb,0xc6,0x25,0x8c,0x5f,0x7a,0x24,0xd5,0xac,0xc4,0xc3,0x0a,0xcb,0x7d,0x7e,0x48,
        0x04,0x40,0xba,0x33,0x79,0xca,0x50,0x1d,0x4f,0xf5,0xbd,0x8e,0x4b,0xee,0xef,0xe6,
        0xcd,0x00,0xe7,0x3f,0xd9,0x65,0xd0,0xcc,0x60,0x27,0x80,0x7b,0xe3,0x7e,0x07,0x85,
        0x13,0x9e,0x26,0xaf,0xc5,0x72,0x44,0xbc,0x6d,0x78,0x50,0x66,0x2f,0x66,0x8f,0x8e,
        0x4f,0xa0,0x34,0x30,0x7c,0x72,0x20,0x46,0x12,0xbd,0x7b,0x74,0xbe,0xf7,0x38,0x11,
        0x9d,0xe6,0x30,0x8b,0x4f,0xcc,0x42,0x16,0xa7,0xd0,0x8d,0x9b,0x7d,0x9e,0x10,0x36,
        0x9d,0x38,0x35,0x76,0x31,0xa3,0x23,0x54,0x74,0x1e,0xc1,0x16,0xd3,0x18,0x59,0xfb,
        0xdf,0x2a,0x7b,0xe4,0x2b,0x0d,0xd3,0xa0,0xb2,0x0f,0x9a,0xe9,0x7e,0xc8,0x0e,0x1e,
        0x13,0xea,0x6a,0x20,0xb9,0x0f,0x68,0x06,0xe4,0xb7,0xad,0x7d,0xca,0xb1,0x83,0x10,
        0xa2,0x9e,0x9f,0xd8,0x39,0x47,0x8f,0x7a,0x8f,0x70,0x57,0xbd,0x90,0xef,0xec,0x5f,
        0xb4,0x1e,0x62,0xe8,0xd6,0x35,0xc5,0x87,0x52,0x27,0x94,0xcd,0xe4,0x53,0xeb,0xb5,
        0xa2,0xd9,0x28,0x61,0x34,0x43,0xab,0x5a,0xd9,0xc9,0x38,0x50,0xba,0x35,0x0c,0x4c,
        0x8c,0xd7,0xc7,0xaa,0x79,0x2f,0x0d,0x00,0x27,0x90,0x08,0x04,0x50,0xbe,0xd8,0x7b,
        0x92,0x08,0x9b,0xb7,0x6d,0xe1,0xc2,0x2e,0x13,0xce,0xbd,0xa3,0xd5,0x22,0x46,0xb9,
        0x27,0xee,0x57,0x28,0xe8,0x7a,0x27,0x2f,0x3c,0x2e,0xbe,0xd0,0xfa,0xd1,0xad,0x91,
        0xb4,0xb4,0x2c,0x43,0xce,0x45,0xc0,0xdb,0x73,0x44,0x65,0x57,0xb4,0x4c,0xda,0x4a,
        0xbb,0xc6,0x25,0x8c,0x5f,0x7a,0x24,0xd5,0xac,0xc4,0xc3,0x0a,0xcb,0x7d,0x7e,0x48,
        0x40,0x40,0xba,0x33,0x79,0xca,0x50,0x1d,0x4f,0xf5,0xbd,0x8e,0x4b,0xee,0xef,0xe6,
        0xcd,0x00,0xe7,0x3f,0xd9,0x65,0xd0,0xcc,0x60,0x27,0x80,0x7b,0xe3,0x7e,0x46,0x89
};

static const unsigned char sm4_test_ctr_key_str[16] = {
        0x2B, 0x7E, 0x15, 0x16, 0x28, 0xAE, 0xD2, 0xA6,
        0xAB, 0xF7, 0x15, 0x88, 0x09, 0xCF, 0x4F, 0x3C,
};
static const unsigned char sm4_test_ctr_iv_str[16] = {
        0x55, 0x5c, 0x82, 0x24, 0xe2, 0xc9, 0x58, 0x73,
        0x12, 0x08, 0x5b, 0xfb, 0x4e, 0xcb, 0x04, 0xb8,
};

static const unsigned char sm4_test_ctr_strblk[16] = {
        0x8e,0x51,0x43,0x98,0x39,0xef,0xcc,0xa0,0x04,0x8a,0xd6,0x9a,0x51,0x56,0xbf,0xc5,
};

static const unsigned char sm4_test_ctr_dec_str[512] = {
        0xb3,0x9a,0xac,0x79,0x5f,0x23,0x12,0x03,0xa8,0x9e,0xc8,0x22,0x5e,0x1c,0xf0,0x28,
        0xfc,0x33,0xf9,0xce,0x2b,0xb6,0x18,0x7d,0x4f,0x98,0xea,0x53,0xba,0xbe,0x0b,0x61,
        0x93,0x94,0x69,0xa0,0x86,0x98,0x2e,0xf3,0xcf,0x9d,0x6f,0x96,0x21,0x18,0xf5,0x2c,
        0x20,0x19,0xf4,0x5a,0xb3,0xad,0x39,0x25,0xc6,0xd3,0x92,0x5b,0xa4,0xd2,0xc8,0xcc,
        0xee,0x43,0x01,0xdd,0x18,0x0f,0x6a,0xe8,0xa3,0x6e,0xd0,0xfb,0x8c,0x66,0x08,0x6a,
        0x5b,0x0a,0x2f,0x82,0xc5,0xfd,0xb7,0x36,0xb5,0x12,0x56,0x45,0x77,0x89,0xe9,0x9d,
        0x09,0xb1,0xa2,0x66,0x2f,0x71,0x04,0x46,0x78,0x35,0xde,0xd6,0x5c,0xe2,0x04,0xae,
        0xdc,0x40,0x57,0xc2,0xcd,0x80,0x09,0xcd,0xe6,0xec,0x92,0x70,0x4b,0x68,0x97,0x24,
        0x9f,0xfc,0xe3,0x39,0xe0,0x74,0xce,0x5b,0xe0,0x08,0x7e,0x7f,0x64,0xaa,0xdf,0xc6,
        0xa7,0x64,0x3f,0x3a,0x5b,0x8e,0xa2,0xb5,0x11,0x10,0x8f,0x5e,0x90,0x94,0x79,0xf6,
        0xe4,0x1a,0x35,0x3d,0x0e,0x11,0xbb,0xb3,0x01,0xdc,0xf7,0x99,0xbc,0xc6,0x14,0x42,
        0xef,0xdf,0xc6,0x94,0x72,0x96,0xa9,0x29,0x7c,0xd5,0x02,0x56,0x46,0x21,0x5c,0xfd,
        0xa4,0x31,0x2c,0xd8,0x9e,0xbc,0x73,0x95,0xa8,0x60,0x80,0xbe,0xed,0x63,0xa5,0x44,
        0xcb,0xdb,0x22,0x2d,0xde,0xc1,0x61,0x99,0xf9,0x8d,0x4c,0x0f,0xdf,0x83,0xa4,0xdb,
        0xef,0x49,0xe9,0x59,0xef,0x95,0x30,0xa8,0xd9,0x1d,0x48,0x1d,0xe2,0xf5,0xde,0xa5,
        0xb7,0x62,0x31,0x7b,0xf3,0x04,0xb7,0xe2,0xbb,0xdb,0xd2,0x41,0xb0,0x31,0x86,0xbc,
        0x3d,0xa7,0x55,0x7b,0x7b,0x69,0x7a,0x60,0x2e,0x84,0x20,0x15,0xd2,0x30,0xb8,0xb2,
        0xae,0x83,0x75,0x75,0xa1,0x4b,0xed,0xfa,0x30,0x9e,0x62,0x26,0xd8,0x8d,0x2f,0xae,
        0xe6,0x10,0xd5,0x60,0x23,0x0c,0xc1,0x24,0x49,0x92,0x98,0xa5,0xd5,0x9c,0x39,0xf1,
        0xe0,0xc0,0x8f,0x37,0x52,0x57,0x96,0x0f,0xf7,0x3d,0x0e,0x8c,0x57,0x5d,0x8c,0xd7,
        0xfa,0xfa,0x5d,0x22,0xc8,0xb3,0x31,0x7f,0x7e,0xb3,0xe5,0x62,0x2c,0xcf,0xb9,0xc4,
        0xdb,0x3f,0x73,0x20,0x90,0x0f,0x99,0x79,0xb9,0x3f,0xb5,0xcf,0x46,0x76,0x7c,0x02,
        0xae,0xe4,0x52,0xf1,0x37,0x1a,0xe9,0x45,0x05,0x72,0x21,0x82,0x12,0x69,0x93,0x5c,
        0xaa,0xc8,0xc0,0x6f,0x0f,0xc3,0x52,0x28,0x5d,0xfb,0x83,0x70,0xdb,0xa9,0xc3,0x6d,
        0x94,0xb0,0x72,0x8d,0xbd,0xbb,0x23,0xd4,0xa4,0x53,0xfa,0x2f,0x30,0x50,0x1d,0x2c,
        0x76,0xdd,0xc9,0xc5,0x6a,0xed,0x4e,0x75,0x64,0x67,0x00,0x7b,0x8c,0x7a,0x79,0xc8,
        0xc0,0xf8,0x3b,0x66,0x9d,0x9b,0x70,0x11,0xd6,0x82,0x0b,0x5a,0xc5,0xbe,0xf9,0xf8,
        0xee,0x46,0xa0,0x62,0x41,0xf3,0xa2,0xef,0xba,0x55,0x1f,0x29,0x51,0xbe,0xb3,0xb6,
        0x82,0xf9,0x24,0x5c,0x1d,0xca,0xf4,0xd7,0x06,0xc0,0x0d,0x95,0xb1,0xfe,0xdf,0xd8,
        0x7a,0x2b,0xdc,0x81,0xf3,0xbc,0x16,0xcd,0x48,0xc4,0x29,0x0e,0x4c,0xec,0x4d,0xfc,
        0x82,0x04,0x86,0x6e,0xa7,0xd1,0xce,0xc8,0x77,0xe0,0xa7,0x11,0x95,0xe3,0x20,0xa6,
        0x5f,0x3d,0xb8,0x12,0x21,0x1b,0xaf,0xec,0x14,0xdb,0xae,0x48,0x68,0x60,0xbf,0x2f,
};

static void test_gmssl_sm4_ctr_enc_str(void)
{
    unsigned char dec_plain[512] = {0};
    unsigned int i = 0;
    int ret = 0;
    uint8_t iv[16] = {0};
    uint8_t strblk[16] = {0};
    size_t nc_off = 7;
    sms4_key_t key;
    memset(strblk,0,sizeof strblk);
    memcpy(iv, sm4_test_ctr_iv, sizeof iv);
    memcpy(strblk, sm4_test_ctr_strblk, sizeof strblk);
    sms4_set_encrypt_key(&key, sm4_test_ctr_key_str);
    sms4_ctr128_encrypt(sm4_test_ctr_enc_str, dec_plain, sizeof(dec_plain), &key, iv, strblk, &nc_off);

#if 0
    for (i = 0; i < sizeof(dec_plain); i ++) {
        if (i % 16 == 0) {
            printf("\n");
        }
        printf("0x%2x,", dec_plain[i]);
    }
    printf("            ");
#endif
    CU_ASSERT_NSTRING_EQUAL(sm4_test_ctr_dec_str, dec_plain, sizeof dec_plain)
}

static void test_gmssl_sm4_ctr_dec_str(void)
{
    unsigned char enc_plain[512] = {0};
    unsigned int i = 0;
    int ret = 0;
    uint8_t iv[16] = {0};
    uint8_t strblk[16] = {0};
    size_t nc_off = 7;
    sms4_key_t key;
    memset(strblk,0,sizeof strblk);
    memcpy(iv, sm4_test_ctr_iv_str, sizeof iv);
    memcpy(strblk, sm4_test_ctr_strblk, sizeof strblk);
    sms4_set_encrypt_key(&key, sm4_test_ctr_key_str);
    sms4_ctr128_encrypt(sm4_test_ctr_dec_str, enc_plain, sizeof(enc_plain), &key, iv, strblk, &nc_off);
#if 0
    for (i = 0; i < sizeof(enc_plain); i ++) {
        if (i % 16 == 0) {
            printf("\n");
        }
        printf("0x%2x,", enc_plain[i]);
    }
    printf("            ");
#endif
    ret = memcmp(sm4_test_ctr_dec, enc_plain, sizeof enc_plain);
    CU_ASSERT_NSTRING_EQUAL(sm4_test_ctr_enc_str, enc_plain, sizeof enc_plain)
}

static CU_TestInfo test_sca_suite[] = {
        {"test gmssl sm4 ecb enc", TEST_FUN(test_gmssl_sm4_ecb_enc)},
        {"test gmssl sm4 ecb dec", TEST_FUN(test_gmssl_sm4_ecb_dec)},
        {"test gmssl sm4 cbc enc", TEST_FUN(test_gmssl_sm4_cbc_enc)},
        {"test gmssl sm4 cbc dec", TEST_FUN(test_gmssl_sm4_cbc_dec)},
        {"test gmssl sm4 ctr enc", TEST_FUN(test_gmssl_sm4_ctr_enc)},
        {"test gmssl sm4 ctr dec", TEST_FUN(test_gmssl_sm4_ctr_dec)},
        {"test mbedtls sm4 ctr-str enc", TEST_FUN(test_gmssl_sm4_ctr_enc_str)},
        {"test mbedtls sm4 ctr-str dec", TEST_FUN(test_gmssl_sm4_ctr_dec_str)},
        CU_TEST_INFO_NULL,
};


static CU_SuiteInfo suites_list[] = {
        //{ "gmssl test cmac",  suite_success_init, suite_success_clean, NULL, NULL, test_cmac_suite},

        { "gmssl test sca",  suite_success_init, suite_success_clean, NULL, NULL, test_sca_suite},

        CU_SUITE_INFO_NULL,
};


void add_gmssl_testsuite(void)
{
    assert(NULL != CU_get_registry());
    assert(!CU_is_test_running());

    /* Register suites. */
    if (CU_register_suites(suites_list) != CUE_SUCCESS) {
        fprintf(stderr, "suite registration failed - %s\n",
                CU_get_error_msg());
        exit(EXIT_FAILURE);
    }

/* implementation without shortcut registration
  CU_pSuite pSuite;

  pSuite = CU_add_suite("suite_success_both", suite_success_init, suite_success_clean);
  CU_add_test(pSuite, "testSuccess1", testSuccess1);
  CU_add_test(pSuite, "testSuccess2", testSuccess2);
  CU_add_test(pSuite, "testSuccess3", testSuccess3);

  pSuite = CU_add_suite("suite_success_init", suite_success_init, NULL);
  CU_add_test(pSuite, "testSuccess1", testSuccess1);
  CU_add_test(pSuite, "testSuccess2", testSuccess2);
  CU_add_test(pSuite, "testSuccess3", testSuccess3);

  pSuite = CU_add_suite("suite_success_clean", NULL, suite_success_clean);
  CU_add_test(pSuite, "testSuccess1", testSuccess1);
  CU_add_test(pSuite, "testSuccess2", testSuccess2);
  CU_add_test(pSuite, "testSuccess3", testSuccess3);

  pSuite = CU_add_suite("test_failure", NULL, NULL);
  CU_add_test(pSuite, "testFailure1", testFailure1);
  CU_add_test(pSuite, "testFailure2", testFailure2);
  CU_add_test(pSuite, "testFailure3", testFailure3);

  / * tests should not run * /
  pSuite = CU_add_suite("suite_failure_both", suite_failure_init, suite_failure_clean);
  CU_add_test(pSuite, "testSuiteFailure1", testSuiteFailure1);
  CU_add_test(pSuite, "testSuiteFailure2", testSuiteFailure2);

  / * tests should not run * /
  pSuite = CU_add_suite("suite_failure_init", suite_failure_init, NULL);
  CU_add_test(pSuite, "testSuiteFailure1", testSuiteFailure1);
  CU_add_test(pSuite, "testSuiteFailure2", testSuiteFailure2);

  / * tests will run, suite counted as running, but suite tagged as a failure * /
  pSuite = CU_add_suite("suite_success_but_failure_clean", NULL, suite_failure_clean);
  CU_add_test(pSuite, "testSuiteFailure1", testSuiteFailure1);
  CU_add_test(pSuite, "testSuiteFailure2", testSuiteFailure2);

  pSuite = CU_add_suite("TestSimpleAssert", NULL, NULL);
  CU_add_test(pSuite, "testSimpleAssert", testSimpleAssert);
  CU_add_test(pSuite, "testFail", testFail);

  pSuite = CU_add_suite("TestBooleanAssert", NULL, NULL);
  CU_add_test(pSuite, "testAssertTrue", testAssertTrue);
  CU_add_test(pSuite, "testAssertFalse", testAssertFalse);

  pSuite = CU_add_suite("TestEqualityAssert", NULL, NULL);
  CU_add_test(pSuite, "testAssertEqual", testAssertEqual);
  CU_add_test(pSuite, "testAssertNotEqual", testAssertNotEqual);

  pSuite = CU_add_suite("TestPointerAssert", NULL, NULL);
  CU_add_test(pSuite, "testAssertPtrEqual", testAssertPtrEqual);
  CU_add_test(pSuite, "testAssertPtrNotEqual", testAssertPtrNotEqual);

  pSuite = CU_add_suite("TestNullnessAssert", NULL, NULL);
  CU_add_test(pSuite, "testAssertPtrNull", testAssertPtrNull);
  CU_add_test(pSuite, "testAssertPtrNotNull", testAssertPtrNotNull);

  pSuite = CU_add_suite("TestStringAssert", NULL, NULL);
  CU_add_test(pSuite, "testAssertStringEqual", testAssertStringEqual);
  CU_add_test(pSuite, "testAssertStringNotEqual", testAssertStringNotEqual);

  pSuite = CU_add_suite("TestNStringAssert", NULL, NULL);
  CU_add_test(pSuite, "testAssertNStringEqual", testAssertNStringEqual);
  CU_add_test(pSuite, "testAssertNStringNotEqual", testAssertNStringNotEqual);

  pSuite = CU_add_suite("TestDoubleAssert", NULL, NULL);
  CU_add_test(pSuite, "testAssertDoubleEqual", testAssertDoubleEqual);
  CU_add_test(pSuite, "testAssertDoubleNotEqual", testAssertDoubleNotEqual);

  pSuite = CU_add_suite("TestFatal", NULL, NULL);
  CU_add_test(pSuite, "testFatal", testFatal);
*/
}

